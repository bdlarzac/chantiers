{{/* 
    Partie de formulaire utilisé par 3 formulaires :
    plaq-form.html, bspied-form.html, chautre-form.html
    
    Cette template doit être appelée avec une struct contenant 2 champs :
    - Chantier (de type Plaq ou BSPied ou Chautre)
    - TypeChantier (string pouvant valoir "plaq" ou "bspied" ou "chautre")
    
    Cette partie de formulaire est contenue dans un <div class="grid2-form">
*/}}

{{with .Chantier}}

<div>
    <label class="block margin-bottom">Unités de gestion</label>
    <center>
        <img class="inline vertical-align-middle bigicon margin-right" src="/static/img/new.png" title="Nouvelle" onclick="addUG();" />
        <img class="inline vertical-align-middle bigicon" src="/static/img/validate.png" title="Valider"  onclick="validateUGs();" />
    </center>
</div>
<div id="liste-ugs"></div>

<script>
//
// variables globalees
//
// pour passer à travers async
window.lienChantierMsg = "";

// Pour mémoriser les associations code ug => id ug lors de l'exec de checkUGs() 
window.globalUGs = [];
    
async function initializeLiensChantier() {
    // form new
    if({{not .Fermiers}}){
        addUG();
    }
    // form update
    else{
console.log("form update");
    }
    
}

/**
    Ajoute une ligne dans la div id="liste-ugs"
    Ligne = Champ pour saisir UG + img pour supprimer la ligne
    ATTENTION : si on modifie la structure d'une ligne,
                - il faut adapter la re-indexation dans removeUG()
                - adapter validateUGs()
**/
function addUG(){
    const listeUgsElt = document.getElementById("liste-ugs");
    const idxNew = listeUgsElt.getElementsByTagName("div").length;
    //
    const divElt = document.createElement("div");
    divElt.setAttribute("id", "ligne-ug-" + idxNew);
    divElt.classList.add("padding-top05");
    //
    const inputElt = document.createElement("input");
    inputElt.setAttribute("type", "text");
    inputElt.setAttribute("id", "ug-" + idxNew);
    inputElt.setAttribute("name", "ug-" + idxNew);
    inputElt.classList.add("input-ug"); // utile seulement dans validateChantierLien()
    //
    const spanElt = document.createElement("span");
    spanElt.innerHTML = " ";
    spanElt.style.width = "1rem";
    //
    const aElt = document.createElement("a");
    aElt.setAttribute("href", "#");                                                                                                    
    aElt.setAttribute("onclick", "removeUG(" + idxNew + ");");
    //
    const imgElt = document.createElement("img");
    imgElt.classList.add("inline", "vertical-align-middle", "bigicon");
    imgElt.setAttribute("src", "/static/img/delete.png");
    imgElt.setAttribute("title", "Valider les UGs - Afficher lieux-dits et fermiers");
    aElt.appendChild(imgElt);
    //
    divElt.appendChild(inputElt);
    divElt.appendChild(spanElt);
    divElt.appendChild(aElt);
    listeUgsElt.appendChild(divElt);
}

/** 
    Enlève une ligne {input text ug + img pour supprimer}
**/
function removeUG(idx){
    document.getElementById("ligne-ug-" + idx).remove();
    const listeUgsElt = document.getElementById("liste-ugs");
    // re-index la valeur de l'attribut id
    // - pour chaque elt de la liste
    // - au sein d'un elt de la liste, pour chaque enfant dont id dépend du param idx
    let elt;
    for(let i=0; i < listeUgsElt.childNodes.length; i++){
        elt = listeUgsElt.childNodes[i];
        elt.setAttribute("id", "ligne-ug-" + i);
        elt.childNodes[0].setAttribute("id", "ug-" + i);                    // input type = text
        elt.childNodes[0].setAttribute("name", "ug-" + i);                  // input type = text
        elt.childNodes[2].setAttribute("onclick", "removeUG(" + i + ");");  // a href de l'img
    }
}

/**
    Appelé quand on clique sur valider UGs
    Remplit ou maj les zones
    <div id="empty-lieudit1"></div><div id="empty-lieudit2"></div>
    <div id="empty-fermier1"></div><div id="empty-fermier2"></div>
**/
async function validateUGs(){
    
    window.lienChantierMsg = "";
    await checkUGs();
    if(window.lienChantierMsg != ""){
        alert(window.lienChantierMsg);
        return;
    }
    
    let i;
    
    // Mémorise ce qui est checked (pour réaffichage suite à nouveau clic sur valider UGs)
    const memoLieudit = [];
    const memoFermier = [];
    let elts;
    elts = document.getElementsByClassName("chk-lieudit");
    for(i = 0; i < elts.length; i++) {
        if(elts[i].checked){
            memoLieudit.push(elts[i].getAttribute("id"));
        }
    }
    elts = document.getElementsByClassName("chk-fermier");
    for(i = 0; i < elts.length; i++) {
        if(elts[i].checked){
            memoFermier.push(elts[i].getAttribute("id"));
        }
    }
    
    // Vide la zone
    document.getElementById("empty-lieudit1").innerHTML = "";
    document.getElementById("empty-lieudit2").innerHTML = "";
    document.getElementById("empty-fermier1").innerHTML = "";
    document.getElementById("empty-fermier2").innerHTML = "";
    
    // variables utiisées par affichage lieux-dits et fermiers
    const listeUgsElt = document.getElementById("liste-ugs");
    let div1Elt, div2Elt; // enfants directs de grid2
    let baseURL, url, codeUG;
    let elt, response;
    let idDB, nom, idForm, divElt, checkElt, labelElt;
    
    // Affiche lieux-dits
    window.lienChantierMsg = "";
    baseURL = "/ajax/get/lieudits-from-code-ug/"
    div1Elt = document.getElementById("empty-lieudit1");
    div1Elt.style.fontWeight = "bold";
    div1Elt.style.textAlign = "right";
    div2Elt = document.getElementById("empty-lieudit2");
    div1Elt.innerHTML = "Lieux-dits";
    for(i=0; i < listeUgsElt.childNodes.length; i++){
        elt = listeUgsElt.childNodes[i];
        codeUG = elt.childNodes[0].value;
        url = baseURL + codeUG;
        response = await fetch(url);
        if(response == null){
            window.lienChantierMsg += "- ERREUR\nTransmettez ce message l'administrateur du site :\n"
                + "Problème de récupération " + url + " dans {{$.TypeChantier}}-form.html\n";
            continue;
        }
        response = await response.json();
        if(response == null){
            window.lienChantierMsg += "- ERREUR\nTransmettez ce message l'administrateur du site :\n"
                + "Mauvais format de retour de " + url + " dans {{$.TypeChantier}}-form.html\n";
            continue;
        }
        if(response.length == 0){
            window.lienChantierMsg += "- L'UG \"" + codeUG + "\" n'est associée à aucun lieu-dit.\n";
            continue;
        }
        response.forEach(function(item){
            idDB = item.Id;
            nom = item.Nom;
            idForm = "lieudit-" + idDB
            checkElt = document.createElement("input");
            checkElt.setAttribute("type", "checkbox");
            checkElt.setAttribute("id", idForm);
            checkElt.setAttribute("name", idForm);                                                                   
            checkElt.setAttribute("class", "chk-lieudit"); // utile uniquement pour calcul de memoLieudit
            if(memoLieudit.indexOf(idForm) != -1){
                checkElt.setAttribute("checked", true);
            }
            labelElt = document.createElement("label");
            labelElt.setAttribute("for", idForm);
            labelElt.style.fontWeight = "normal";
            labelElt.innerHTML = nom;
            divElt = document.createElement("div");
            divElt.appendChild(checkElt);
            divElt.appendChild(labelElt);
            div2Elt.appendChild(divElt);
        });
    }
    
    if(window.lienChantierMsg != ""){
        alert(window.lienChantierMsg);
        return;
    }
    
    // Affiche fermiers
    window.lienChantierMsg = "";
    baseURL = "/ajax/get/fermiers-from-code-ug/"
    div1Elt = document.getElementById("empty-fermier1");
    div1Elt.style.fontWeight = "bold";
    div1Elt.style.textAlign = "right";
    div2Elt = document.getElementById("empty-fermier2");
    div1Elt.innerHTML = "Fermiers";
    for(i=0; i < listeUgsElt.childNodes.length; i++){
        elt = listeUgsElt.childNodes[i];
        codeUG = elt.childNodes[0].value;
        url = baseURL + codeUG;
        response = await fetch(url);
        if(response == null){
            window.lienChantierMsg += "- ERREUR\nTransmettez ce message l'administrateur du site :\n"
                + "Problème de récupération " + url + " dans {{$.TypeChantier}}-form.html\n";
            continue;
        }
        response = await response.json();
        if(response == null){
            window.lienChantierMsg += "- ERREUR\nTransmettez ce message l'administrateur du site :\n"
                + "Mauvais format de retour de " + url + " dans {{$.TypeChantier}}-form.html\n";
            continue;
        }
        if(response.length == 0){
            window.lienChantierMsg += "- L'UG \"" + codeUG + "\" n'est associée à aucun lieu-dit.\n";
            continue;
        }
        response.forEach(function(item){
            idDB = item.id;
            nom = item.name;
            idForm = "fermier-" + idDB
            checkElt = document.createElement("input");
            checkElt.setAttribute("type", "checkbox");
            checkElt.setAttribute("id", idForm);
            checkElt.setAttribute("name", idForm);
            checkElt.setAttribute("class", "chk-fermier"); // utile uniquement pour calcul de memoFermier
            if(memoFermier.indexOf(idForm) != -1){
                checkElt.setAttribute("checked", true);
            }
            labelElt = document.createElement("label");
            labelElt.setAttribute("for", idForm);
            labelElt.style.fontWeight = "normal";
            labelElt.innerHTML = nom;
            divElt = document.createElement("div");
            divElt.appendChild(checkElt);
            divElt.appendChild(labelElt);
            div2Elt.appendChild(divElt);
        });
    }
}

/** 
    Vérifie si les UGs saisies existent en base
    Remplit la var globale window.globalUGs
    Remplit éventuellement la var globale window.lienChantierMsg
**/
async function checkUGs(){
    const baseURL = "/ajax/get/ug-from-code/";
    const listeUgsElt = document.getElementById("liste-ugs");
    let url ="";
    let codeUG = "";
    let elt, response;
    for(let i=0; i < listeUgsElt.childNodes.length; i++){
        elt = listeUgsElt.childNodes[i];
        codeUG = elt.childNodes[0].value;
        url = baseURL + codeUG;
        response = await fetch(url);
        if(response == null){
            window.lienChantierMsg += "- ERREUR\nTransmettez ce message l'administrateur du site :\n"
                + "Problème de récupération " + url + " dans {{$.TypeChantier}}-form.html\n";
            continue;
        }
        response = await response.json();
        if(response == null){
            window.lienChantierMsg += "- ERREUR\nTransmettez ce message l'administrateur du site :\n"
                + "Mauvais format de retour de " + url + " dans {{$.TypeChantier}}-form.html\n";
            continue;
        }
        if(response == 0){
            window.lienChantierMsg += "- L'UG \"" + codeUG + "\" n'existe pas en base.\n";
            continue;
        }
        window.globalUGs[codeUG] = response;
    }
}

/** 
    Valide la partie ugs, lieux-dits et fermiers.
    @return     Message d'erreur, chaîne vide si ok.
**/
function validateFormChantierLien(){
    let msg = "";
    let i;
    // UGs
    let val;
    const ugs = document.getElementsByClassName("input-ug");
    for(i = 0; i < ugs.length; i++) {
        val = ugs[i].value;
        if(val == ""){
            msg += "- Un champ pour saisir une UG ne peut pas être vide\n";
            continue;
        }
        if(!(val in window.globalUGs)){
            msg += "L'UG \"" + val + "\" n'existe pas en base\n";
        }
    }
    // lieux-dits
    let elts, nChecked;
    nChecked = 0;
    elts = document.getElementsByClassName("chk-lieudit");
    for(i = 0; i < elts.length; i++) {
        if(elts[i].checked){
            nChecked++;
        }
    }
    if(nChecked == 0){
        msg += "- Vous devez choisir au moins un lieu-dit\n";
    }
    // fermiers
    nChecked = 0;
    elts = document.getElementsByClassName("chk-fermier");
    for(i = 0; i < elts.length; i++) {
        if(elts[i].checked){
            nChecked++;
        }
    }
    if(nChecked == 0){
        msg += "- Vous devez choisir au moins un fermier\n";
    }
    return msg;
}

/** 
    Fonction à appeler uniquement lorsque le formulaire est valide, juste avant de le poster.
    Remplace les codes UG par les ids UG dans les inputs
    Ex : remplace "XIX-11" par 6
    Ça permet au controller qui traite le formulaire d'avoir directement les ids UG
**/
function bidouilleUGChantierLien(){
    const ugs = document.getElementsByClassName("input-ug");
    let val;
    for(i = 0; i < ugs.length; i++) {
        val = ugs[i].value;
        ugs[i].value = window.globalUGs[val];
    }
}

</script>
{{end}}