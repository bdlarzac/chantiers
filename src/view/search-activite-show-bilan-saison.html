{{/*
    @copyright  BDL, Bois du Larzac.
    @licence    GPL, conformémént au fichier LICENCE situé à la racine du projet.
*/}}

<style>
    #table-bilan-saison{
        margin-left:1rem;
        border-collapse:collapse;
    }
    #table-bilan-saison td{
        padding:3px;
        white-space:nowrap;
    }
    #table-bilan-saison .ligne-titre-saison{
        background:none;
        font-weight:bold;
    }
    #table-bilan-saison td.titre-saison{
        padding-bottom:5px;
    }
    #table-bilan-saison tr.ligne-bilan{
        outline:1px solid grey;
    }
    #table-bilan-saison td.valo{
        font-weight:bold;
        text-align:right;
        padding-right:1rem;
    }
    #table-bilan-saison td.volume{
        color:red;
    }
    #table-bilan-saison td.prix{
    }
</style>

<script>
    const totaux = new Map();
</script>

{{with .Details}}
    {{$nbProprios := len .LabelProprios}}
    {{with .BilansActivitesParSaison}}
        <table id="table-bilan-saison" class="entities">
            <tbody>
                {{/* loop sur les saisons */}}
                {{range .}}
                    {{range $idProprio, $labelProprio := $.Details.LabelProprios}}
                        <script>
                            totaux.set({{$idProprio}}, 0);
                        </script>
                    {{end}}
                    <tr class="ligne-titre-saison">
                        <td class="titre-saison" colspan="3">
                            {{.Datedeb | dateFr}} - {{.Datefin | dateFr}}
                        </td>
                    </tr>
                    
                    {{if $.Details.HasPlaquettes}}
                    <tr class="ligne-bilan">
                        <td class="valo">
                            Plaquettes vendues
                        </td>
                        <td>
                            <table>
                            {{$totalVentes := .TotalVentePlaquettesParProprio}}
                            {{range $idProprio, $labelProprio := $.Details.LabelProprios}}
                                <tr>
                                    <td>
                                        {{index $.Details.LabelProprios $idProprio}}
                                    </td>
                                    <td class="padding-left right">
                                        <script>document.write(formatNb(round({{index $totalVentes $idProprio}}, 2)));</script> maps
                                    </td>
                                </tr>
                            {{end}}
                            </table>
                        </td>
                    </tr>
                    <tr class="ligne-bilan">
                        <td class="valo">
                            Plaquettes coupées
                        </td>
                        <td>
                            <table>
                            {{$totalPlaquettes := .TotalActivitesPlaquettesParProprio}}
                            {{range $idProprio, $labelProprio := $.Details.LabelProprios}}
                                <tr>
                                    <td>
                                        {{index $.Details.LabelProprios $idProprio}}
                                    </td>
                                    <td class="padding-left right">
                                        {{$totalCourant := index $totalPlaquettes $idProprio}}
                                        <script>document.write(formatNb(round({{$totalCourant.Volume}}, 2)));</script> maps
                                    </td>
                                </tr>
                            {{end}}
                            </table>
                        </td>
                    </tr>
                    {{end}}{{/* fin plaquettes */}}
                    
                    {{range $valo, $totalActivite := .TotalActivitesParValoEtProprio}}
                    <tr class="ligne-bilan">
                        <td class="valo">
                            {{$valo | labelValo}}
                        </td>
                        <td>
                            <table style="width:100%;">
                            {{range $idProprio, $labelProprio := $.Details.LabelProprios}}
                                <tr>
                                {{$totalCourant := index $totalActivite $idProprio}}
                                    <td style="width:25%;">
                                        {{index $.Details.LabelProprios $idProprio}}
                                    </td>
                                    <td class="padding-left right" style="width:45%;">
                                        <script>document.write(formatNb(round({{$totalCourant.Volume}}, 2)));</script>
                                        {{$valo | valo2uniteLabel}}
                                    </td>
                                    <td class="padding-left right" style="width:30%;">
                                        <script>document.write(formatNb(round({{$totalCourant.PrixHT}}, 2)));</script>
                                        &euro;
                                    </td>
                                </tr>
                            {{end}}
                            </table>
                        </td>
                    </tr>
                    {{end}}{{/* fin loop .TotalActivitesParValoEtProprio */}}
                    
                    
                {{end}}{{/* fin loop sur les saisons */}}
            </tbody>
        </table>
    {{else}}
        <div class="big2 bold">Aucune activité ne correspond aux critères demandés</div>
    {{end}}

{{end}}
