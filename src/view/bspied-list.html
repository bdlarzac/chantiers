<h1>
    {{.Header.Title}}
    <a class="padding-left" href="/chantier/bois-sur-pied/new">
        <img class="bigicon inline" src="/static/img/new.png" title="Créer un nouveau chantier bois sur pied" />
    </a>
</h1>

{{if .Details.Annees}}
<div>
    Autres années :
    {{range .Details.Annees}}
    <a class="padding-left" href="/chantier/bois-sur-pied/liste/{{.}}">{{.}}</a>
    {{end}}
</div>
{{end}}

{{if .Details.Chantiers}}
<table class="entities">
    
    <tr>
        <th colspan="2"></th>
        <th>Parcelles - UG</th>
        <th>Prix</th>
        <th>Facture</th>
        <th>Notes</th>
    </tr>
    {{range .Details.Chantiers}}
    <tr>
        <td class="whitespace-nowrap">
            <a href="#" onclick='showBSPFacture({{.Id}}, "{{.NumFacture}}", "{{.DateFacture | dateFr}}");'>
                <img src="/static/img/facture.png" title="Voir la facture" />
            </a>
            <a href="/chantier/bois-sur-pied/update/{{.Id}}" class="padding-left05">
                <img src="/static/img/update.png" title="Modifier ce chantier" />
            </a>
            <a href="#" onclick="deleteChantier({{.Id}}, {{.Acheteur.String}}, {{.DateContrat | dateFr}});" class="padding-left05">
                <img src="/static/img/delete.png" title="Supprimer ce chantier">     
            </a>
        </td>
        <td>
            <div class="grid2-pres">
                <div>Acheteur</div>
                <div><a href="/acteur/{{.IdAcheteur}}">{{.Acheteur.String}}</a></div>
                
                <div>Date contrat</div>    
                <div>{{.DateContrat | dateFr}}</div>
                
                <div>Lieu-dit</div>
                <div><a href="/lieudit/{{.IdLieudit}}">{{.Lieudit.Nom}}</a></div>
                
                <div>Essence</div>
                <div>{{.Essence | labelEssence}}</div>
                
                <div>Exploitation</div>
                <div>{{.Exploitation | labelExploitation}}</div>
                
                <div>N stères contrat</div>
                <div>{{.NStereContrat}}</div>
            </div>
        </td>
        <td class="vertical-align-top">
            <script>
                var i = 1;                                     
                var len = {{len .Parcelles}}
            </script>
            {{range .Parcelles}}
            <a href="/parcelle/{{.Id}}">{{.Code}}</a>
            <script>
                if(i % 3 ==0 && i < len){
                    document.write("<br>");
                }
                i++;
            </script>
            {{end}}
            <hr>
            <a href="/unite-gestion/{{.IdUG}}">{{.UG.String}}</a>
        </td>
        <td>
            <div class="grid2-pres">
                <div>N stères coupées</div>
                <div>{{.NStereCoupees}}</div>
                
                <div>Prix / stère</div>
                <div><script>document.write(round({{.PrixStere}}, 2));</script></span> &euro;</div>
                
                <div>Total HT</div>
                <div><script>document.write(round(prixHT({{.PrixStere}}, {{.NStereCoupees}}), 2));</script></span> &euro;</div>
                
                <div>TVA</div>
                <div>{{.TVA}}</span> %</div>
                
                <div>Total TTC</div>
                <div><script>document.write(round(prixTTC(prixHT({{.PrixStere}}, {{.NStereCoupees}}), {{.TVA}}), 2));</script></span> &euro;</div>
            </div>
        </td>
        <td>
            <div class="grid2-pres">
                <div>Date</div>
                <div>{{.DateFacture | dateFr}}</div>
                
                <div>Numéro</div>
                <div>{{.NumFacture}}</div>
            </div>
        </td>
        <td>{{.Notes | nl2br}}</td>
    </tr>
    {{end}}

</table>                                                                 

<!-- ************************************* -->
<h3>Total {{.Details.Annee}} (stères coupées)</h3>
<table class="entities">
    {{range $key, $value := .Details.TotalParEssence}}
    <tr>
        <td>{{$key | labelEssence}}</td>
        <td><b><script>document.write(round({{$value}}, 2));</script></b></td>
    </tr>
    {{end}}
</table>

{{end}} {{/* end if .Details.Chantiers */}}

<script>
// *****************************************
function deleteChantier(idChantier, acheteur, date){
    const msg = "Attention, en cliquant sur OK,\n"
            + "le chantier " + acheteur + " - "  + date + "\nsera définitivement supprimé";
    let r = confirm(msg);
    if (r == true) {
        window.location = "/chantier/bois-sur-pied/delete/" + idChantier;
    }
}

// *****************************************
/** 
    Sert de filtre pour afficher uniquement les factures contenant suffisamment d'information.
**/
function showBSPFacture(idChantier, numFacture, dateFacture) {
    if(numFacture == "" || dateFacture == ""){
        alert(
            "Pour voir la facture, il faut d'abord renseigner :"
            + "\n- le numéro de facture"
            + "\n- la date de facture"
            + "\nModifiez le chantier et renseignez ces 2 champs."
        );
        return;
    }
    window.location = "/facture/bois-sur-pied/" + idChantier;
}
</script>
