{{/* 
    Formulaire de choix d'une ou plusieurs parcelles.
    
    Doit être appelé avec une variable contenant un champ AllCommunes.
    
    Utilisation :
        <script>
            choixParcelle = new ChoixParcelle('choix-parcelle');
            choixParcelle.display();
            choixParcelle.initialize();
        </script>

	@copyright  BDL, Bois du Larzac.
	@licence    GPL, conformémént au fichier LICENCE situé à la racine du projet.
*/}}

<script>

class ChoixParcelle {
    
    #html;
    
    #baseId;
    
    static currentParcelles;
    
    /** 
        @param  baseId String - Unique id of this component within the page.
    **/
    constructor(baseId){
        //
        this.#baseId = baseId;
        //
        this.#html = `
        <fieldset class="choix-parcelle">
            <legend>Parcelles</legend>
            <details open>
                <summary><span id="${this.#baseId}-summary" class="padding-left2">{{/* filled by js */}}</span></summary>
                <div class="margin-right margin-top05">
                    <select class=" margin-right" name="choix-parcelle-select-commune" id="choix-parcelle-select-commune" onChange="choixParcelle_communeChanged();">
                        <option id="CHOOSE_COMMUNE" value="CHOOSE_COMMUNE">--- Choisir une commune ---</option>`;
                        {{range .AllCommunes}}
                            this.#html += '<option id="choix-parcelle-commune-' + {{.Id}} + '" value="choix-parcelle-commune-' + {{.Id}} + '">' + {{.Nom}} + '</option>\n';
                        {{end}}
        this.#html += `
                    </select>
                    <img 
                        class="inline vertical-align-middle bigicon"
                        src="/static/img/new.png"
                        title="Choisir une ou plusieurs parcelles sur cette commune"
                        onclick="showModalParcelle();"
                    />
                </div>
                <div id="zone-parcelles"></div>
            </details>
        </fieldset>
        `;
    } // end constructor
    
    display(){
        document.write(this.#html);
    }
    
    initialize(){
        choixParcelle_choixChanged(this.#baseId);
    }
    
} // end class

function choixParcelle_choixChanged(baseId){
    // update summary string
    document.getElementById(baseId + '-summary').innerHTML = 'Toutes les parcelles';
}


async function choixParcelle_communeChanged(){
    if(document.getElementById('CHOOSE_COMMUNE').selected){
        return;
    }
    // Ajax pour récup parcelles correspondant à la commune
    const selectElt = document.getElementById('choix-parcelle-select-commune');
    const optionElt = selectElt.options[selectElt.selectedIndex];
    const idCommune = optionElt.getAttribute('id').replace('choix-parcelle-commune-', '');
    const url = "/ajax/get/parcelles-from-id-commune/" + idCommune;
    let response = await fetch(url);
    if(response == null){
        alert("ERREUR - Transmettez ce message l'administrateur du site :\n"
            + "Problème de récupération " + url);
        return;                                                                     
    }
    response = await response.json();
    if(response == null){
        alert("ERREUR - Transmettez ce message l'administrateur du site :\n"
            + "Mauvais format de retour de " + url);
        return;
    }
    ChoixParcelle.currentParcelles = response;
}

</script>