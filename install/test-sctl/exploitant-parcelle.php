<?php
/******************************************************************************
    Teste les associations entre parcelles et exploitants

    @copyright  BDL, Bois du 
    @license    GPL
    @history    2019-11-07 16:12:42+01:00, Thierry Graff : Creation
********************************************************************************/
/*
Table Exploita contient les détails des exploitants (adresse mail tel etc.)

Recad
    IdParcelle
    IdExploitant
SubdivCadastre
    IdParcelle
    IdExploitant                               
Subdivision
    IdParcelle
    IdExploitant

Conclusions :
- on laisse tomber Recad
- on utilise Subdivision, qui est plus complète que SubdivCadastre
*/

require_once 'csvAssociative.php';

$csvDir = '/home/thierry/dev/jobs/bdl/appli/install/data';
$privateDir = '/home/thierry/dev/jobs/bdl/appli/private';
$tables = ['Recad', 'SubdivCadastre', 'Subdivision'];

//test_ids($csvDir, $tables);
test_evolutionExploita();

// ******************************************************
/**
    Compare les 3 tables avec la table Exploita
    Résultats :
        Exploita : 104
        Recad : 97
        SubdivCadastre : 103
        Subdivision : 103
        diff Exploita - Recad : 101 102 103 104 105 106 107 108 109 110
        diff Exploita - SubdivCadastre : 23
        diff Exploita - Subdivision : 23
        == 1 PERSONNE
          Dans Subdivision et pas dans SubdivCadastre : 2108
**/
function test_ids($csvDir, $tables){
    
    $exp =[];
    $csv = csvAssociative::compute($csvDir . '/Exploita.csv');
    foreach($csv as $row){
        $exp[$row['IdExploitant']] = $row['NOMEXP'];
    }
    $keysExp = array_keys($exp);
    echo 'Exploita : ' . count($exp) . "\n";
    
    $data = [];
    foreach($tables as $table){
        $data[$table] = [];
        $csv = csvAssociative::compute($csvDir . '/' . $table . '.csv');
        foreach($csv as $row){
            if(!isset($data[$table][$row['IdExploitant']])){
                $data[$table][$row['IdExploitant']] = [];
            }
            $data[$table][$row['IdExploitant']][] = $row['IdParcelle'];
        }
    }
    foreach($tables as $table){
        foreach($data[$table] as $k => $v){
            $data[$table][$k] = array_unique($v);
        }
    }
    
    
    foreach($tables as $table){
        echo "$table : " . count($data[$table]) . "\n";
    }
    
    $keys = [];
    foreach($tables as $table){
        $keys[$table] = array_keys($data[$table]);
        $diff = array_diff($keysExp, $keys[$table]);
        echo "diff Exploita - $table : " . implode(' ', $diff) . "\n";
    }
    
    // on laisse tomber recad
    
    foreach($data['SubdivCadastre'] as $idE => $idsP){
        $diff1 = array_diff($idsP, $data['Subdivision'][$idE]);
        $diff2 = array_diff($data['Subdivision'][$idE], $idsP);
        if(count($diff1) == 0 && count($diff2) == 0){
            continue;
        }
        echo "== $idE " . $exp[$idE] . "\n";
        if(count($diff1) != 0){
            echo '  Dans SubdivCadastre et pas dans Subdivision : ' . implode(' ', $diff1) . "\n";
        }
        if(count($diff2) != 0){
            echo '  Dans Subdivision et pas dans SubdivCadastre : ' . implode(' ', $diff2) . "\n";
        }
    }
}

// ******************************************************
/**
    Construit un csv avec les ids et noms des exploitants
    pour différentes versions de la table Exploita
    Conclusions :
    - IdExploitant est lié à un bail (?)
        cf 94 GREFFIER D.-  BLANC M.    => BLANC - LEVI
        cf 86 POULANGES                 => ALLAIN / de ANGELIS
    - NUMEXP est lié à une personne

**/
function test_evolutionExploita(){
    $outfile = '/home/thierry/dev/jobs/bdl/2.build/db-sctl/analyse/evolution-Exploita.csv';
    $indirs = [
        '2018'       => '/home/thierry/dev/jobs/bdl/2.build/db-sctl/csv-2018',
        '2020-02-27' => '/home/thierry/dev/jobs/bdl/2.build/db-sctl/csv-2020-02-27',
        '2020-03-02' => '/home/thierry/dev/jobs/bdl/2.build/db-sctl/csv-2020-03-02',
        '2020-03-06' => '/home/thierry/dev/jobs/bdl/2.build/db-sctl/csv-2020-03-06',
        '2020-12-16' => '/home/thierry/dev/jobs/bdl/2.build/db-sctl/csv-2020-12-16',
    ];
    $res = [];
    foreach($indirs as $key => $dir){
        $in = csvAssociative::compute("$dir/Exploita.csv");
        foreach($in as $line){
            $idExp = $line['IdExploitant'];
            if(!isset($res[$idExp])){
                $res[$idExp] = [];
            }
            $res[$idExp][$key] = ['NOMEXP' => $line['NOMEXP'], 'NUMEXP' => $line['NUMEXP']];
        }
    }
    // generate output
    $out = 'IdEx;';
    $outKeys = ['IdEx'];
    foreach(array_keys($indirs) as $key){
        $out .= "NOMEXP-$key;NUMEXP-$key;";
        $outKeys[] = "NOMEXP-$key";
        $outKeys[] = "NUMEXP-$key";
    }
    $out = substr($out, 0, -1) . "\n";
    foreach($res as $idExp => $elt){
        $new = array_fill_keys($outKeys, '');
        $new['IdEx'] = $idExp;
        foreach($elt as $k1 => $v1){
            foreach($v1 as $k2 => $v2){
                $new["$k2-$k1"] = $v2;
            }
        }
        $out .= implode(';', $new) . "\n";
//echo "$out"; exit;
    }
    file_put_contents($outfile, $out);
}