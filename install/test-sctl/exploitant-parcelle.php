<?php
/******************************************************************************
    Teste les associations entre parcelles et exploitants

    @copyright  BDL, Bois du 
    @license    GPL
    @history    2019-11-07 16:12:42+01:00, Thierry Graff : Creation
********************************************************************************/
/*
Table Exploita contient les détails des exploitants (adresse mail tel etc.)

Recad
    IdParcelle
    IdExploitant
SubdivCadastre
    IdParcelle
    IdExploitant                               
Subdivision
    IdParcelle
    IdExploitant

Conclusions :
- on laisse tomber Recad
- on utilise Subdivision, qui est plus complète que SubdivCadastre
*/

require_once 'csvAssociative.php';

$csvDir = '/home/thierry/dev/jobs/bdl/appli/install/data';
$privateDir = '/home/thierry/dev/jobs/bdl/appli/private';
$tables = ['Recad', 'SubdivCadastre', 'Subdivision'];

test_ids($csvDir, $tables);


// ******************************************************
/**
    Compare les 3 tables avec la table Exploita
    Résultats :
        Exploita : 104
        Recad : 97
        SubdivCadastre : 103
        Subdivision : 103
        diff Exploita - Recad : 101 102 103 104 105 106 107 108 109 110
        diff Exploita - SubdivCadastre : 23
        diff Exploita - Subdivision : 23
        == 1 PERSONNE
          Dans Subdivision et pas dans SubdivCadastre : 2108
**/
function test_ids($csvDir, $tables){
    
    $exp =[];
    $csv = csvAssociative::compute($csvDir . '/Exploita.csv');
    foreach($csv as $row){
        $exp[$row['IdExploitant']] = $row['NOMEXP'];
    }
    $keysExp = array_keys($exp);
    echo 'Exploita : ' . count($exp) . "\n";
    
    $data = [];
    foreach($tables as $table){
        $data[$table] = [];
        $csv = csvAssociative::compute($csvDir . '/' . $table . '.csv');
        foreach($csv as $row){
            if(!isset($data[$table][$row['IdExploitant']])){
                $data[$table][$row['IdExploitant']] = [];
            }
            $data[$table][$row['IdExploitant']][] = $row['IdParcelle'];
        }
    }
    foreach($tables as $table){
        foreach($data[$table] as $k => $v){
            $data[$table][$k] = array_unique($v);
        }
    }
    
    
    foreach($tables as $table){
        echo "$table : " . count($data[$table]) . "\n";
    }
    
    $keys = [];
    foreach($tables as $table){
        $keys[$table] = array_keys($data[$table]);
        $diff = array_diff($keysExp, $keys[$table]);
        echo "diff Exploita - $table : " . implode(' ', $diff) . "\n";
    }
    
    // on laisse tomber recad
    
    foreach($data['SubdivCadastre'] as $idE => $idsP){
        $diff1 = array_diff($idsP, $data['Subdivision'][$idE]);
        $diff2 = array_diff($data['Subdivision'][$idE], $idsP);
        if(count($diff1) == 0 && count($diff2) == 0){
            continue;
        }
        echo "== $idE " . $exp[$idE] . "\n";
        if(count($diff1) != 0){
            echo '  Dans SubdivCadastre et pas dans Subdivision : ' . implode(' ', $diff1) . "\n";
        }
        if(count($diff2) != 0){
            echo '  Dans Subdivision et pas dans SubdivCadastre : ' . implode(' ', $diff2) . "\n";
        }
    }
}

